#include <WiFi.h>

// ==== WiFi Credentials ====
const char* ssid = "SSID";
const char* password = "pass";

// ==== Server Setup ====
WiFiServer server(8080);
WiFiClient client;

void setup() {
  Serial.begin(9600);
  Serial2.begin(9600, SERIAL_8N1, 16, 17); // RX=16, TX=17 (to Arduino)

  Serial.println("\nConnecting to WiFi...");
  WiFi.begin(ssid, password);

  int retries = 0;
  while (WiFi.status() != WL_CONNECTED && retries < 30) {
    delay(500);
    Serial.print(".");
    retries++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… WiFi Connected!");
    Serial.print("ðŸ“¡ IP Address: ");
    Serial.println(WiFi.localIP());
    server.begin();
    Serial.println("ðŸŒ Server started on port 8080");
  } else {
    Serial.println("\nâŒ WiFi Connection Failed!");
  }
}

void loop() {
  // Accept client
  if (!client || !client.connected()) {
    client = server.available();
    if (!client) {
      delay(100);
      return;
    }
    Serial.println("ðŸ’» Client Connected!");
  }

  // Handle incoming command
  if (client.available()) {
    String cmd = client.readStringUntil('\n');
    cmd.trim();

    if (cmd.length() > 0) {
      Serial.print("ðŸ“© Received: ");
      Serial.println(cmd);

      // Handle special commands
      if (cmd == "PING") {
        client.println("PONG");
      } 
      else {
        Serial2.println(cmd);   // Send to Arduino
        client.println("OK");   // Confirm to Python
      }
    }
  }

  // Heartbeat every 3 seconds
  static unsigned long lastPing = 0;
  if (millis() - lastPing > 3000) {
    if (client.connected()) {
      client.println("ALIVE");
    }
    lastPing = millis();
  }

  // Disconnect client
  if (!client.connected()) {
    Serial.println("ðŸ”Œ Client Disconnected");
    client.stop();
  }
}
